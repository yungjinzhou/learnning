## 网络协议学习



### 学习网络协议的必要性



#### 协议三要素：

语法、语义、顺序

#### 经常见到的网络协议

![1634653296698](.\1634653296698.png)



#### 浏览器从发送请求到目标地址的过程

1. 输入网址后，本机首先首先DNS(HTTPDNS)查到ip地址；

2. 然后HTTP(s)协议加要发送的内容，到传输层；
3. socket(TCP/UDP)传输层，传输层封装完毕后交给网络层(IP协议)；
4. 在IP协议里会有源IP地址和目标IP地址，然后发送到网关（系统启动时，DHCP协议配置IP地址和默认网关）；
5. 通过ARP协议，找到MAC地址，到了数据链路层；
6. 网关往往是一个路由器，路由器里记录的有路由表，通过路由协议找到对应的远端地址；
7.  然后是ARP协议，找到MAC地址，找到服务器，然后给TCP层，到应用层，访问相应的内容。

### 协议分层的含义



当然网络包的格式很复杂，这个程序也很复杂。复杂的程序都要分层，这是程序设计的要求。

 ![img](.\5c00f6e610f533d17fb4ad7decacc776.jpg) 



### ifconfig包含的信息及协议



#### 无类型域间选路（CIDR）

于是有了一个折中的方式叫作无类型域间选路，简称 CIDR。这种方式打破了原来设计的几类地址的做法，将 32 位的 IP 地址一分为二，前面是网络号，后面是主机号。从哪里分呢？你如果注意观察的话可以看到，10.100.122.2/24，这个 IP 地址中有一个斜杠，斜杠后面有个数字 24。这种地址表示形式，就是 CIDR。后面 24 的意思是，32 位中，前 24 位是网络号，后 8 位是主机号。

伴随着 CIDR 存在的，一个是广播地址，10.100.122.255。如果发送这个地址，所有 10.100.122 网络里面的机器都可以收到。另一个是子网掩码，255.255.255.0。

将子网掩码和 IP 地址进行 AND 计算。前面三个 255，转成二进制都是 1。1 和任何数值取 AND，都是原来数值，因而前三个数不变，为 10.100.122。后面一个 0，转换成二进制是 0，0 和任何数值取 AND，都是 0，因而最后一个数变为 0，合起来就是 10.100.122.0。这就是网络号。将子网掩码和 IP 地址按位计算 AND，就可得到网络号。



 **解析16.158.165.91/22 这个 CIDR**

/22 不是 8 的整数倍，不好办，只能先变成二进制来看。16.158 的部分不会动，它占了前 16 位。中间的 165，变为二进制为‭10100101‬。除了前面的 16 位，还剩 6 位。所以，这 8 位中前 6 位是网络号，16.158.<101001>，而 <01>.91 是机器号。

第一个地址是 16.158.<101001><00>.1，即 16.158.164.1。子网掩码是 255.255.<111111><00>.0，即 255.255.252.0。广播地址为 16.158.<101001><11>.255，即 16.158.167.255。

#### 公有IP地址和私有IP地址

 ![img](.\df90239efec6e35880b9abe55089ffa9.jpg) 

#### lo

lo 全称是 loopback，又称环回接口，往往会被分配到 127.0.0.1 这个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。

#### MAC

MAC 地址在 IP 地址的上一行是 link/ether fa:16:3e:c7:79:75 brd ff:ff:ff:ff:ff:ff，这个被称为 MAC 地址，是一个网卡的物理地址，用十六进制，6 个 byte 表示。

MAC 地址更像是身份证，是一个唯一的标识。

#### 网络设备的状态标识

解析完了 MAC 地址，我们再来看 <BROADCAST,MULTICAST,UP,LOWER_UP> 是干什么的？这个叫做 net_device flags，网络设备的状态标识。

UP 表示网卡处于启动的状态；BROADCAST 表示这个网卡有广播地址，可以发送广播包；MULTICAST 表示网卡可以发送多播包；LOWER_UP 表示 L1 是启动的，也即网线插着呢。

MTU1500 是指最大传输单元 MTU 为 1500，这是以太网的默认值。

MTU 是二层 MAC 层的概念。MAC 层有 MAC 的头，以太网规定正文部分不允许超过 1500 个字节。正文里面有 IP 的头、TCP 的头、HTTP 的头。如果放不下，就需要分片来传输。

#### 分片传输/排队规则

qdisc pfifo_fast 是什么意思呢？**qdisc** 全称是 **queueing discipline**，中文叫排队规则。内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的 qdisc（排队规则）把数据包加入队列。

1. 最简单的 qdisc 是 **pfifo**，它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。

2. **pfifo_fast** 稍微复杂一些，它的队列包括三个波段（band）。在每个波段里面，使用先进先出规则。

   三个波段（**band**）的优先级也不相同。band 0 的优先级最高，band 2 的最低。如果 band 0 里面有数据包，系统就不会处理 band 1 里面的数据包，band 1 和 band 2 之间也是一样。

数据包是按照服务类型（Type of Service，**TOS**）被分配到三个波段（band）里面的。TOS 是 IP 头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的。



### DHCP和PXE







