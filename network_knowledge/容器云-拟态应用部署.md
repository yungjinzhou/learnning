



### 大体部署顺序 

顺序：部署本地私有仓库，格式化物理机，部署kvm环境（在此期间物理机三个网桥设置好），搭建虚机（包括网络），部署云管，交换机配置，部署集群





内生安全原生云平台-云管快速安装指南

1. ce-release-3.0.0.tar、harbor-offline、kubeoperator-release-v3.15.1-zjs-amd64.tar.gz、kubeoperator-release-v3.15.1-zjs-arm64.tar.gz 移入cloudexplorerinstall下。含义及下载位置
2. arm集群镜像服务器
3. 







### 容器云云管平台操作

容器云：admin/fit2cloud
创建添加容器云账号：需要master url，token, webconsole，获取位置？

组件管理，添加那些组件？，组件导入问题，组件实例固定？









#### 成都

部署本地私有仓库（系统离线源仓库，公司的硬盘中），







格式化物理机，部署kvm环境（在此期间物理机三个网桥设置好），搭建虚机（包括网络）

成都问题解决的文档中有步骤



分区  

/boot   2G  



x86  /  /boot

arm   /boot/efi   /   /boot



交换机配置



部署云管平台

部署容器云集群

habor仓库部署



##### 应用处理

制作镜像

根据不同异构指标，先制作对应的基础镜像，后续如果应用又更新只需要更新应用代码制作新镜像即可

制作好镜像后，在本地打包，推送到habor镜像，供yml文件的image：字段值使用

应用上传之前，切换到开发空间，先申请命名空间

切换到管理员，右上角提示，通过申请

切换到开发空间，应用部署，导入yaml文件、

yml文件，需要针对不同应用写不同的命令



容器云添加到云管平台



调试应用

制作镜像

从云管平台上传

调试右括号，拟态组件

使用





#### 长沙

调试应用

制作镜像

habor导入应用

从云管平台上传

使用















### 容器云部署











### cobbler学习











### pxe学习





### ansbile学习















### lvs学习

#### ipvsadm使用

```
sudo ipvsadm -A -t 10.2.10.10:80 -s rr         #定义集群服务
sudo ipvsadm -a -t 10.2.10.10:80 -r 172.17.0.6 -m #添加 RealServer1
sudo ipvsadm -a -t 10.2.10.10:80 -r 172.17.0.7 -m #添加 RealServer2
sudo ipvsadm -l                 #查看 ipvs 定义的规则
# 添加集群服务
-A：添加一个新的集群服务
-t: 使用 TCP 协议
-s: 指定负载均衡调度算法
rr：轮询算法(LVS 实现了 8 种调度算法)
192.168.100.5:8888  定义集群服务的 IP 地址（VIP） 和端口

# 添加 Real Server 规则
-a：添加一个新的 RealServer 规则
-t：tcp 协议
-r：指定 RealServer IP 地址
-m：定义为 NAT 
上面命令添加了两个服务器 RealServer1 和 RealServer2

sudo ipvsadm -C #清除 ipvsadm 的规则
```



ipvsadm（IP Virtual Server Administration）是 Linux 系统下一个用于管理 LVS（Linux Virtual Server）集群的工具，它支持多种负载均衡算法，包括：

1. 轮询算法（Round Robin，简称 rr）

轮询算法将客户端请求平均地分配到后端服务器。例如，在有 3 台服务器的情况下，第一个请求会被分配到服务器 1，第二个请求会被分配到服务器 2，第三个请求会被分配到服务器 3，第四个请求会被分配到服务器 1，以此类推。

1. 最少连接算法（Least Connections，简称 lc）

最少连接算法会优先将客户端请求分配给后端连接数最少的服务器。这个算法通常用于处理长连接的场景，如视频流等。

1. 源地址散列算法（Source Hash，简称 sh）

源地址散列算法根据源 IP 地址进行哈希计算，然后将哈希值对服务器数量取模，以确定发送请求的服务器。

1. 目的地址散列算法（Destination Hash，简称 dh）

目的地址散列算法根据目标 IP 地址进行哈希计算，然后将哈希值对服务器数量取模，以确定发送请求的服务器。

1. 加权轮询算法（Weighted Round Robin，简称 wrr）

加权轮询算法会按照服务器的权重比例分配客户端请求到服务器。例如，如果有 3 台服务器，服务器 1 的权重为 2，服务器 2 的权重为 1，服务器 3 的权重为 1，则前两个请求会被分配到服务器 1，第三个请求会被分配到服务器 2，第四个请求会被分配到服务器 1，第五个请求会被分配到服务器 3，以此类推。



ipvs测试用例参考链接，arm机器，有时候会出现宿主机配置了ipv4_forward转发，但是容器内没有网络的情况，重启docker服务或重启宿主机尝试





#### LVS/NAT 的实现

首先为了能够使用 IPVS 内核模块，我们将在宿主机中安装 ipvsadm，并尝试能否使用：

```
sudo apt-get update # 更新源 
sudo apt-get install ipvsadm # 安装 ipvsadm 工具
sudo ipvsadm -L # 尝试使用 ipvsadm
```

使用 docker 创建所需 container，使用以下命令创建

```
docker run --privileged --name=RealServer1 -tdi ubuntu
docker run --privileged --name=RealServer2 -tdi ubuntu
```

RealServer 部署 Nginx 来提供 Web 服务，RealServer1 和 RealServer2 操作步骤相同，此处以 RealServer1 为示

```
docker attach RealServer1
apt-get update
apt-get install vim -y 
apt-get install nginx -y
service nginx start
```

\#RealServer1 container 环境 sudo vi /var/www/html/index.nginx-debian.html(不同的安装方式路径不同) 修改默认页面移区分2台服务器

至此我们完成两台 Web 服务器的配置，我们可以打开宿主机 firefox 浏览器，地址栏分别输入两个 IP 地址，来检验我们的配置成功：

![img](https://img2018.cnblogs.com/blog/209993/201908/209993-20190823184113619-1389569280.png)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)

LoadBalancer（宿主） 的对外 IP 地址为 VIP，即 **VIP 地址为 10.2.10.10( \**10.2.10.10 是虚拟出来的，\**我的外网是10.2.0.xx )**，开启 LoadBalancer 的内核路由转发

```
echo '1' | sudo tee /proc/sys/net/ipv4/ip_forward
cat /proc/sys/net/ipv4/ip_forward #1 1 说明此机器已开启内核路由转发
```

.使用 ipvsadm 添加 ipvs 规则。定义集群服务：

[![复制代码](https://common.cnblogs.com/images/copycode.gif)](javascript:void(0);)

```
sudo ipvsadm -A -t 10.2.10.10:80 -s rr         #定义集群服务
sudo ipvsadm -a -t 10.2.10.10:80 -r 172.17.0.6 -m #添加 RealServer1
sudo ipvsadm -a -t 10.2.10.10:80 -r 172.17.0.7 -m #添加 RealServer2
sudo ipvsadm -l                 #查看 ipvs 定义的规则
# 添加集群服务
-A：添加一个新的集群服务
-t: 使用 TCP 协议
-s: 指定负载均衡调度算法
rr：轮询算法(LVS 实现了 8 种调度算法)
192.168.100.5:8888  定义集群服务的 IP 地址（VIP） 和端口

# 添加 Real Server 规则
-a：添加一个新的 RealServer 规则
-t：tcp 协议
-r：指定 RealServer IP 地址
-m：定义为 NAT 
上面命令添加了两个服务器 RealServer1 和 RealServer2
```

[![复制代码](https://common.cnblogs.com/images/copycode.gif)](javascript:void(0);)

测试结果（如果强制刷新没有变化 就把对应的nginx关闭再看看）

![img](https://img2018.cnblogs.com/blog/209993/201908/209993-20190823184206909-127751797.png)







##### 配置虚拟ip (vip)

Ubuntu22.04 

在 /etc/netplan/ 目录下修改 .yaml 文件，例如 /etc/netplan/01-network-manager-all.yaml，并将以下配置复制到该文件中：

```
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: true
      addresses:
        - 192.168.1.10/24
        - 192.168.2.10/24
      routes:
        - to: 192.168.2.0/24
          via: 192.168.1.1
      gateway4: 192.168.1.1
```

以上配置表示添加了两个虚拟 IP 地址：192.168.1.10 和 192.168.2.10。其中，192.168.1.10 所在的网段与当前网络接口的地址在同一网段，无需添加静态路由；而 192.168.2.10 所在的网段与当前网络接口的地址不在同一网段，需要添加静态路由才能进行通信。

添加静态路由

如果新添加的虚拟 IP 地址与当前物理网络不在同一网段，则必须添加静态路由才能进行通信。例如，在上述配置中，如果当前的 IP 地址为 192.168.1.100，需要访问的网关 IP 地址为 192.168.2.1，则可以使用以下命令添加静态路由：

```
sudo ip route add 192.168.2.0/24 via 192.168.1.1
```

应用配置

保存上述文件后，运行以下命令使更改生效：

```
sudo netplan apply
```







参考文献：https://www.cnblogs.com/majiang/p/11402015.html



#### LVS/DR 的实现



Aarch64  centos:7.9上测试

宿主机需要支持ip_vs



```
lsmod | grep ip_vs

modprobe ip_vs

```

创建3个容器

```
```

安装基础包（3个容器都执行）

```
yum install -y net-tools vim iproute 
```



LB服务器操作

```
lsmod | grep ip_vs
modprobe ip_vs


```





RS服务器操作

```



#/bin/bash
vip=172.17.0.100
ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up
route add -host $vip lo:0
echo "1" >/proc/sys/net/ipv4/conf/lo/arp_ignore
echo "2" >/proc/sys/net/ipv4/conf/lo/arp_announce
echo "1" >/proc/sys/net/ipv4/conf/all/arp_ignore
echo "2" >/proc/sys/net/ipv4/conf/all/arp_announce
```





yum install -y httpd



















