#### 1. 平均负载

       ##### 1.1 定义
平均负载其实就是平均活跃进程数。平均活跃进程数，直观上的理解就是单位时间内的活跃进程数，但它实际上是活跃进程数的指数衰减平均值。

先查看系统有几个cpu     ```grep 'model name' /proc/cpuinfo | wc -l```, 当平均负载比 CPU 个数还大的时候，系统已经出现了过载。

当平均负载高于 CPU 数量 70% 的时候，你就应该分析排查负载高的问题了。一旦负载过高，就可能导致进程响应变慢，进而影响服务的正常功能。

##### 1.2 常用分析命令

stress 是一个 Linux 系统压力测试工具，这里我们用作异常进程模拟平均负载升高的场
景。

```
运行 stress 命令，模拟一个 CPU 使用率 100% 的场景 
stress --cpu 1 --timeout 600
另一个终端查看
watch -d uptime，查看cpu平均负载

# -P ALL 表示监控所有 CPU，后面数字 5 表示间隔 5 秒后输出一组数据
$ mpstat -P ALL 5

# 间隔 5 秒后输出一组数据，查看哪个进程 的cpu使用率，哪个命令导致的
$ pidstat -u 5 1

CPU 密集型进程特点：
1 分钟的平均负载会慢慢增加到 1.00，而从终端三中还可以看到，
正好有一个 CPU 的使用率为 100%，但它的 iowait 只有 0。这说明，平均负载的升高正
是由于 CPU 使用率为 100% 。



# 运行 stress 命令，但这次模拟 I/O 压力，即不停地执行 sync
stress -i 1 --timeout 600

I/O 密集型进程的特点：
用mpstat -P ALL 5分析
1 分钟的平均负载会慢慢增加到 1.06，其中一个 CPU 的系统 CPU 使用
率升高到了 23.87，而 iowait 高达 67.53%。这说明，平均负载的升高是由于 iowait 的升
高。




大量进程的场景的特点：
当系统中运行进程超出 CPU 运行能力时，就会出现等待 CPU 的进程。
使用 stress，但这次模拟的是 8 个进程
$ stress -c 8 --timeout 600
，8 个进程在争抢 2 个 CPU，每个进程等待 CPU 的时间（也就是代码块中的
%wait 列）高达 75%。这些超出 CPU 计算能力的进程，最终导致 CPU 过载。
```



而 sysstat 包含了常用的 Linux 性能工具，用来监控和分析系统的性能。我们的案例会用
到这个包的两个命令 mpstat 和 pidstat。

mpstat 是一个常用的多核 CPU 性能分析工具，用来实时查看每个 CPU 的性能指标，
以及所有 CPU 的平均指标。
pidstat 是一个常用的进程性能分析工具，用来实时查看进程的 CPU、内存、I/O 以及
上下文切换等性能指标。













